
@{
    ViewBag.Title = "课件树形";
}

@section Styles{

    <style>
        .content_flex {
            padding: 0 12px;
            display: flex;
        }

            .content_flex div {
                margin-right: 10px;
            }

        .fill_width {
            width: 100%;
        }
    </style>

    <link href="~/layui-v2.5.6/layui/css/layui.css" rel="stylesheet" />
    <link href="~/layui_ext/dtree/dtree.css" rel="stylesheet" />
    <link href="~/layui_ext/dtree/font/dtreefont.css" rel="stylesheet" />
}


<div class="main-content">
    <div class="main-content-inner">
        <div class="breadcrumbs ace-save-state" id="breadcrumbs">
            <ul class="breadcrumb">
                <li>
                    <i class="menu-icon fa fa-pencil-square-o"></i>
                    <a href="#">教学审核</a>
                </li>
                <li class="active">课件菜单</li>
            </ul><!-- /.breadcrumb -->
            <!--<div class="nav-search" id="nav-search">
                <form class="form-search">
                    <span class="input-icon">
                        <input type="text" placeholder="Search ..." class="nav-search-input" id="nav-search-input" autocomplete="off" />
                        <i class="ace-icon fa fa-search nav-search-icon"></i>
                    </span>
                </form>
            </div>-->
            <!-- /.nav-search -->
        </div>

        <div class="page-content">
            <fieldset class="layui-elem-field layui-field-title">
                <legend>文件管理</legend>
                <div class="layui-field-box">
                    <div class="layui-row layui-col-space10" style="margin-top: 10px;">
                        <div class="layui-col-xs12">
                            <div>
                                <button type="button" class="layui-btn layui-btn-normal" onclick="fileUpload()">文件上传</button>
                            </div>
                            <div id="toolbarDiv" style="overflow: auto">
                                <ul id="demoTree" class="dtree" data-id="0"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </fieldset>
        </div><!-- /.page-content -->
    </div>
</div><!-- /.main-content -->

@*修改弹出层*@
<div hidden="hidden" id="UpdateFormModel">
    <form class="layui-form" action="">
        <div class="layui-form-item">
            <input type="text" id="U_CoursewareId" hidden="hidden" />@*主键*@
            <div class="layui-inline">
                <label class="layui-form-label">编号</label>
                <div class="layui-input-block">
                    <input type="text" id="U_CoursewareCode" readonly="readonly" name="U_CoursewareCode" lay-verify="required" lay-reqtext="请输入编号" autocomplete="off" placeholder="请输入" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">文件名称</label>
                <div class="layui-input-block">
                    <input type="text" id="U_CoursewareName" readonly="readonly" name="U_CoursewareName" lay-verify="required" lay-reqtext="请输入文件名称" autocomplete="off" placeholder="请输入" class="layui-input">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">文件类型</label>
                <div class="layui-input-block">
                    <input type="text" id="U_IsWebPub" name="U_IsWebPub" readonly="readonly" autocomplete="off" placeholder="请输入" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">图标</label>
                <div class="layui-input-block">
                    <input type="text" id="U_Icon" name="U_Icon" autocomplete="off" placeholder="请输入" class="layui-input">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">排序</label>
                <div class="layui-input-block">
                    <input type="text" id="U_SortID" name="U_SortID" autocomplete="off" placeholder="请输入" class="layui-input">
                </div>
            </div>
        </div>

        <div class="layui-form-item">
            <div class="layui-input-block">
                <button type="submit" class="layui-btn" lay-submit="" lay-filter="demo1" onclick="UpdateData()">立即提交</button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>
</div>



@*上传文件 添加*@
<div hidden="hidden" id="UploadFormModel">
    <form class="layui-form" action="ProcessUploadFiles" method="post" enctype="multipart/form-data">

        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">排序</label>
                <div class="layui-input-block">
                    <input type="text" name="SortID" autocomplete="off" placeholder="请输入" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">图标</label>
                <div class="layui-input-block">
                    <input type="text" name="Icon" autocomplete="off" placeholder="请输入" class="layui-input">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">备注</label>
                <div class="layui-input-block">
                    <input type="text" name="Remark" autocomplete="off" placeholder="请输入" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">文件</label>
                <div class="layui-input-block">
                    <input type="text" id="F_ID" name="F_ID" hidden="hidden" />
                    <input type="file" name="filename" accept=".doc,.docx,.pptx,.ppt,.pps,.pdf" id="file1" />
                </div>
            </div>
        </div>


        <div class="layui-form-item">
            <div class="layui-input-block">
                <button type="submit" class="layui-btn" lay-submit="" lay-filter="demo1">立即提交</button>
            </div>
        </div>
    </form>
</div>

@*导出文件*@
<div hidden="hidden" id="DeriveFormModel">
    <form class="layui-form" action="DownFile">

        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">文件名</label>
                <div class="layui-input-block">
                    <input type="text" id="DeriveCoursewareName" name="DeriveCoursewareName" autocomplete="off" placeholder="请输入" class="layui-input">
                </div>
            </div>
        </div>


        <div class="layui-form-item">
            <div class="layui-input-block">
                <button type="submit" class="layui-btn" lay-submit="" lay-filter="demo1">下载</button>
            </div>
        </div>
    </form>
</div>


@section Scripts{
    <!-- page specific plugin scripts -->
    <script src="~/assets/js/bootstrap-datepicker.min.js"></script>
    <script src="~/assets/js/jquery.jqGrid.min.js"></script>
    <script src="~/assets/js/grid.locale-en.js"></script>
    <script src="~/assets/js/ace-elements.min.js"></script>
    <script type="text/javascript" src="~/incubator-echarts-4.6.0/dist/echarts.min.js"></script>
    <script src="~/Scripts/My97DatePicker/WdatePicker.js" type="text/javascript"></script>
    <script type="text/javascript">
        if ('ontouchstart' in document.documentElement) document.write("<script src='assets/js/jquery.mobile.custom.min.js'>" + "<" + "/script>");
    </script>
    <script src="~/layui-v2.5.6/layui/layui.js"></script>
    <script type="text/javascript">
        layui.extend({
            dtree: '{/}../layui_ext/dtree/dtree'
        }).use(['element', 'layer', 'table', 'code', 'util', 'dtree', 'form'], function () {
            var element = layui.element, layer = layui.layer, table = layui.table, util = layui.util, dtree = layui.dtree, form = layui.form, $ = layui.$;

            // var data = [{ 'id': '001', 'title': '湖南省', 'last': false, 'parentId': '0', 'children': [{ 'id': '001001', 'title': '长沙市', 'last': true, 'parentId': '001' }, { 'id': '001002', 'title': '株洲市', 'last': true, 'parentId': '001' }, { 'id': '001003', 'title': '湘潭市', 'last': true, 'parentId': '001' }, { 'id': '001004', 'title': '衡阳市', 'last': true, 'parentId': '001' }, { 'id': '001005', 'title': '郴州市', 'last': true, 'parentId': '001' }] }, { 'id': '002', 'title': '湖北省', 'last': false, 'parentId': '0', 'children': [{ 'id': '002001', 'title': '武汉市', 'last': true, 'parentId': '002' }, { 'id': '002002', 'title': '黄冈市', 'last': true, 'parentId': '002' }, { 'id': '002003', 'title': '潜江市', 'last': true, 'parentId': '002' }, { 'id': '002004', 'title': '荆州市', 'last': true, 'parentId': '002' }, { 'id': '002005', 'title': '襄阳市', 'last': true, 'parentId': '002' }] }, { 'id': '003', 'title': '广东省', 'last': false, 'parentId': '0', 'children': [{ 'id': '003001', 'title': '广州市', 'last': false, 'parentId': '003', 'children': [{ 'id': '003001001', 'title': '天河区', 'last': true, 'parentId': '003001' }, { 'id': '003001002', 'title': '花都区', 'last': true, 'parentId': '003001' }] }, { 'id': '003002', 'title': '深圳市', 'last': true, 'parentId': '003' }, { 'id': '003003', 'title': '中山市', 'last': true, 'parentId': '003' }, { 'id': '003004', 'title': '东莞市', 'last': true, 'parentId': '003' }, { 'id': '003005', 'title': '珠海市', 'last': true, 'parentId': '003' }, { 'id': '003006', 'title': '韶关市', 'last': true, 'parentId': '003' }] }, { 'id': '004', 'title': '浙江省', 'last': false, 'parentId': '0', 'children': [{ 'id': '004001', 'title': '杭州市', 'last': true, 'parentId': '004' }, { 'id': '004002', 'title': '温州市', 'last': true, 'parentId': '004' }, { 'id': '004003', 'title': '绍兴市', 'last': true, 'parentId': '004' }, { 'id': '004004', 'title': '金华市', 'last': true, 'parentId': '004' }, { 'id': '004005', 'title': '义乌市', 'last': true, 'parentId': '004' }] }, { 'id': '005', 'title': '福建省', 'last': false, 'parentId': '0', 'children': [{ 'id': '005001', 'title': '厦门市', 'last': true, 'parentId': '005' }] }];
            SelectAll = function () {
                //开始演示
                layer.load(1, {//加载
                    shade: [0.1, '#fff'] //0.1透明度的白色背景
                });
                $.ajax({
                    type: "POST",
                    url: "/Swf/SelectTree",
                    dataType: "json",
                    data: {},
                    success: function (data) {
                        console.log(data);
                        var DTree = dtree.render({
                            elem: "#demoTree",
                            width: "100%",
                            data: eval(data),
                            // url: "/Swf/SelectTree",
                            initLevel: "99",
                            line: true,
                            toolbar: true,
                            toolbarShow: ["pulldown", "pullup"],  // 这样就只会出现两个了
                            toolbarExt: [{
                                toolbarId: "Add",
                                icon: "dtree-icon-roundadd",
                                title: "新增子级",
                                handler: function (node) {
                                    //layer.msg(JSON.stringify(node) + "添加");
                                    //$('#AddModal').modal('show');
                                    // console.log(JSON.stringify(node));

                                    $("#P_CoursewareCode").val(node.nodeId);//赋值父级ID
                                    $("#F_ID").val(node.nodeId);//赋值父级ID

                                    AddSelect();//赋值下拉框
                                    //页面层
                                    layer.open({
                                        title: '添加子级',
                                        type: 1,
                                        // skin: 'layui-layer-rim', //加上边框
                                        area: ['720px', '340px'], //宽高
                                        content: $('#UploadFormModel')
                                    });
                                }
                            }, {
                                toolbarId: "Update",
                                icon: "dtree-icon-bianji",
                                title: "编辑",
                                handler: function (node) {
                                    //layer.msg(JSON.stringify(node) + "编辑");
                                    // console.log(JSON.stringify(node));
                                    //赋值
                                    $("#U_CoursewareId").val(node.nodeId);

                                    Assign();

                                }
                            }, {
                                toolbarId: "Delete",
                                icon: "dtree-icon-delete1",
                                title: "删除",
                                handler: function (node) {
                                    // layer.msg(JSON.stringify(node) + "删除");
                                    // console.log(node.recordData);
                                    DeleteData(node.nodeId, node.context);
                                }
                            },
                            {
                                toolbarId: "Derive",
                                icon: "dtree-icon-delete1",
                                title: "导出课件",
                                handler: function (node) {
                                    $("#DeriveCoursewareName").val(node.context);
                                    //页面层
                                    layer.open({
                                        title: '导出课件',
                                        type: 1,
                                        // skin: 'layui-layer-rim', //加上边框
                                        area: ['420px', '240px'], //宽高
                                        content: $('#DeriveFormModel')
                                    });
                                }
                            }],

                        });

                        //此处演示关闭
                        setTimeout(function () {
                            layer.closeAll('loading');
                        });
                    }
                });

            }

            //dtree.on("node(demoTree)", function (obj) {
            // alert(JSON.stringify(obj));
            // })
            //添加数据
            AddData = function () {
                var CoursewareCode = $("#CoursewareCode").val();
                var P_CoursewareCode = $("#P_CoursewareCode").val();
                var CoursewareName = $("#CoursewareName").val();
                var IsWebPub = $("#IsWebPub").val();
                var Icon = $("#Icon").val();
                var UserCode = $("#UserCode").val();
                var CoursewarePath = $("#CoursewarePath").val();
                var SortID = $("#SortID").val();

                $.ajax({
                    type: "POST",
                    url: "/Swf/AddData",
                    dataType: "json",
                    data: {
                        "CoursewareCode": CoursewareCode,
                        "CoursewareName": CoursewareName,
                        "P_CoursewareCode": P_CoursewareCode,
                        "IsWebPub": IsWebPub,
                        "Icon": Icon,
                        "UserCode": UserCode,
                        "CoursewarePath": CoursewarePath,
                        "SortID": SortID,

                    },
                    success: function (data) {
                       
                        if (data > 0) {
                            layer.msg("添加成功");
                        } else {
                            layer.msg("添加失败");
                        }
                    }
                });
            }


            //赋值编辑框
            Assign = function () {
                //开始演示
                layer.load(1, {//加载
                    shade: [0.1, '#fff'] //0.1透明度的白色背景
                });



                var U_CoursewareId = $("#U_CoursewareId").val();

                $.ajax({
                    type: "POST",
                    url: "/Swf/Assign",
                    dataType: "json",
                    data: {
                        U_CoursewareId: U_CoursewareId
                    },
                    success: function (data) {
                        // console.log(data);
                        $("#U_CoursewareCode").val(data.CoursewareCode);
                        $("#U_CoursewareName").val(data.CoursewareName);
                        $("#U_IsWebPub").val(data.IsWebPub);
                        $("#U_Icon").val(data.Icon);
                        $("#U_SortID").val(data.SortID);

                        //页面层 打开弹窗
                        layer.open({
                            title: '编辑',
                            type: 1,
                            // skin: 'layui-layer-rim', //加上边框
                            area: ['820px', '440px'], //宽高
                            content: $('#UpdateFormModel')
                        });

                        //此处演示关闭
                        setTimeout(function () {
                            layer.closeAll('loading');
                        });
                    }
                });
            }

            //编辑数据
            UpdateData = function () {
                var U_CoursewareId = $("#U_CoursewareId").val();
                var U_CoursewareCode = $("#U_CoursewareCode").val();
                var U_CoursewareName = $("#U_CoursewareName").val();
                var U_IsWebPub = $("#U_IsWebPub").val();
                var U_Icon = $("#U_Icon").val();
                var U_SortID = $("#U_SortID").val();
                $.ajax({
                    type: "POST",
                    url: "/Swf/UpdateData",
                    dataType: "json",
                    data: {
                        U_CoursewareId: U_CoursewareId,
                        U_CoursewareCode: U_CoursewareCode,
                        U_CoursewareName: U_CoursewareName,
                        U_IsWebPub: U_IsWebPub,
                        U_Icon: U_Icon,
                        U_SortID: U_SortID
                    },
                    success: function (data) {
                        if (data > 0) {
                            layer.msg("修改成功");
                        } else {
                            layer.msg("修改失败");
                        }
                    }
                });
            }

            //删除数据
            DeleteData = function (CoursewareId, CoursewareName) {
                //开始演示
                layer.load(1, {//加载
                    shade: [0.1, '#fff'] //0.1透明度的白色背景
                });
                if (confirm("确认删除？")) {
                    $.ajax({
                        type: "POST",
                        url: "/Swf/DeleteTempFiles",
                        data: {
                            "CoursewareId": CoursewareId,
                            "CoursewareName": CoursewareName
                        },
                        success: function (data) {
                            if (data) {
                                layer.msg("删除成功");
                                SelectAll();
                            } else {
                                layer.msg("删除失败");
                            }
                            //此处演示关闭
                            setTimeout(function () {
                                layer.closeAll('loading');
                            });
                        }
                    });
                }
            }


            //上传一级文件
            fileUpload = function () {
                $("#F_ID").val("");
                AddSelect();//赋值下拉框
                //页面层
                layer.open({
                    title: '添加一级',
                    type: 1,
                    // skin: 'layui-layer-rim', //加上边框
                    area: ['820px', '440px'], //宽高
                    content: $('#UploadFormModel')
                });
            }

          
            $(function () {
                SelectAll();
            });

              //赋值添加下拉框
            AddSelect = function () {
                $.ajax({
                    type: "POST",
                    url: "/Swf/AddSelect",
                    data: {
                    },
                    success: function (data) {
                        //console.log(data);
                        var str = "";
                        for (var i = 0; i < data.length; i++) {
                           
                            str += "<option value='" + data[i].UserCode+"'>" + data[i].UserCode+"</option>";
                        }
                        console.log(str);
                        $("#UserCode").append(str);
                        form.render();//没有写这个，操作后没有效果
                    }
                });
            }
        });
    </script>

}